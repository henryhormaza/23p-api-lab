def json_output
pipeline {
  environment {
    registry = "us.gcr.io/alien-bruin-284822/23p-api-lab:latest"
    registryCredential = 'alien-bruin-284822'
    //json_key_file = credentials('alien-bruin-284822-json')
    TF_VAR_auth_file = credentials('alien-bruin-284822-json')
  }
  agent any
  stages {
    
    
    
    stage('Cloning Git') {
      steps {                       
            git 'https://github.com/henryhormaza/23p-api-lab.git'
        }
    }
    stage('Build_infra') {
        steps {
            dir("Terraform/"){
                sh "gcloud auth activate-service-account service-23people@alien-bruin-284822.iam.gserviceaccount.com --key-file ${TF_VAR_auth_file}"                                
                sh "terraform init -get -backend-config credentials=${TF_VAR_auth_file}"
                sh "terraform apply  -auto-approve -get -backend-config credentials=${TF_VAR_auth_file}"                
                sh "terraform output -json > output.json"   
                
                //script{
                //        json_output = readJSON(file: 'output.json')
                //   }
                //sh "echo ${json_output.toString()}"
            }
        }
    }
    stage("Building image"){
        steps{
            script{
                
                dockerImage = docker.build("alien-bruin-284822/23p-api-lab:latest",
                    "-f Docker/23p-api-lab.dockerfile .")
            }
            
        }
    }
    stage("Pushing Image") {
        steps{
            script{
                //sh "cp /tmp/output.json " 
                docker.withRegistry('https://us.gcr.io', 'gcr:alien-bruin-284822') {
                    dockerImage.push("latest")
                }
                    
            }   
        }
        
    }
    
    stage('Rollout POD Image') {
        steps{
            script{
                sh "gcloud auth activate-service-account service-23people@alien-bruin-284822.iam.gserviceaccount.com --key-file ${TF_VAR_auth_file}"                                
                sh "gcloud auth activate-service-account 'gcr:alien-bruin-284822'"
                sh "gcloud container clusters get-credentials p23-cluster --region us-central1 --project alien-bruin-284822"
                sh "kubectl rollout restart deploy/p23"                
                sh "echo 'rollout'"
            }
        }
    }
  }
}
